<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>sosiologe messenger</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background:#0f172a;
  color:white;
}
#auth, #app { display:none; height:100vh; }
#auth {
  display:flex;
  justify-content:center;
  align-items:center;
}
.auth-box {
  background:#020617;
  padding:20px;
  width:300px;
  border-radius:10px;
}
input, button {
  width:100%;
  margin:6px 0;
  padding:10px;
  border-radius:6px;
  border:none;
}
button {
  background:#2563eb;
  color:white;
  cursor:pointer;
}
#app {
  display:flex;
}
#users {
  width:30%;
  background:#020617;
  padding:10px;
}
#chat {
  flex:1;
  display:flex;
  flex-direction:column;
}
#messages {
  flex:1;
  padding:10px;
  overflow:auto;
}
.msg {
  margin:5px 0;
}
.me { text-align:right; color:#60a5fa; }
#send {
  display:flex;
}
#send input { flex:1; }
</style>
</head>
<body>

<div id="auth">
  <div class="auth-box">
    <h3>Вход / Регистрация</h3>
    <input id="email" placeholder="Email">
    <input id="username" placeholder="Username">
    <input id="password" type="password" placeholder="Пароль">
    <button onclick="register()">Регистрация</button>
    <button onclick="login()">Вход</button>
  </div>
</div>

<div id="app">
  <div id="users">
    <input id="search" placeholder="Поиск username" oninput="searchUser()">
    <div id="userList"></div>
  </div>
  <div id="chat">
    <div id="messages"></div>
    <div id="send">
      <input id="text">
      <button onclick="send()">➤</button>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBMhpCKnZnzWryB5q614gbRUt7qdWL-4wg",
  authDomain: "sosiologe.firebaseapp.com",
  projectId: "sosiologe"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let me = null;
let chatWith = null;

auth.onAuthStateChanged(u=>{
  if(u){
    me=u;
    document.getElementById('auth').style.display='none';
    document.getElementById('app').style.display='flex';
  }else{
    document.getElementById('auth').style.display='flex';
    document.getElementById('app').style.display='none';
  }
});

function register(){
  const e=email.value,p=password.value,u=username.value;
  auth.createUserWithEmailAndPassword(e,p).then(r=>{
    db.collection('users').doc(r.user.uid).set({username:u});
  });
}

function login(){
  auth.signInWithEmailAndPassword(email.value,password.value);
}

function searchUser(){
  const q=search.value;
  db.collection('users').where('username','>=',q).limit(10).get().then(s=>{
    userList.innerHTML='';
    s.forEach(d=>{
      if(d.id!==me.uid){
        const div=document.createElement('div');
        div.textContent=d.data().username;
        div.onclick=()=>openChat(d.id);
        userList.appendChild(div);
      }
    });
  });
}

function openChat(uid){
  chatWith=uid;
  messages.innerHTML='';
  db.collection('messages')
    .where('users','in',[[me.uid,uid],[uid,me.uid]])
    .orderBy('time')
    .onSnapshot(s=>{
      messages.innerHTML='';
      s.forEach(d=>{
        const m=document.createElement('div');
        m.className='msg'+(d.data().from===me.uid?' me':'');
        m.textContent=d.data().text;
        messages.appendChild(m);
      });
    });
}

function send(){
  if(!chatWith)return;
  db.collection('messages').add({
    from:me.uid,
    to:chatWith,
    users:[me.uid,chatWith],
    text:text.value,
    time:firebase.firestore.FieldValue.serverTimestamp()
  });
  text.value='';
}
</script>
</body>
</html>
