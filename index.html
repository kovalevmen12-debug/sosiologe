<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>sosiologe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body { margin:0; font-family: Arial; background:#f2f2f2; }
    header { background:#111; color:#fff; padding:10px; display:flex; justify-content:space-between; }
    .btn { padding:8px 12px; background:#007bff; color:#fff; border:none; border-radius:5px; }
    .container { max-width:600px; margin:auto; padding:10px; }
    .post { background:#fff; margin-top:10px; padding:10px; border-radius:8px; }
    .hidden { display:none; }
    img { max-width:100%; border-radius:8px; }
    input, textarea { width:100%; margin-top:5px; padding:8px; }
    .like { cursor:pointer; color:#007bff; }
  </style>
</head>
<body>

<header>
  <div><b>sosiologe</b></div>
  <div id="userName"></div>
</header>

<!-- AUTH -->
<div class="container" id="auth">
  <h3>–í—Ö–æ–¥</h3>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
  <button class="btn" onclick="login()">–í–æ–π—Ç–∏</button>

  <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
  <input id="regName" placeholder="–ò–º—è">
  <input id="regEmail" placeholder="Email">
  <input id="regPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
  <button class="btn" onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
</div>

<!-- APP -->
<div class="container hidden" id="app">
  <h3>–ù–æ–≤—ã–π –ø–æ—Å—Ç</h3>
  <textarea id="postText" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"></textarea>
  <input id="postImage" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
  <button class="btn" onclick="addPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>

  <div id="posts"></div>
</div>

<script>
  // üî• –¢–í–û–ô CONFIG (–£–ñ–ï –ü–û–î–°–¢–ê–í–õ–ï–ù)
  const firebaseConfig = {
    apiKey: "AIzaSyBMhpCKnZnzWryB5q614gbRUt7qdWL-4wg",
    authDomain: "sosiologe.firebaseapp.com",
    projectId: "sosiologe",
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let currentUser = null;

  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      document.getElementById("auth").classList.add("hidden");
      document.getElementById("app").classList.remove("hidden");
      loadUser();
      loadPosts();
    } else {
      document.getElementById("auth").classList.remove("hidden");
      document.getElementById("app").classList.add("hidden");
    }
  });

  function register() {
    const email = regEmail.value;
    const pass = regPassword.value;
    const name = regName.value;

    auth.createUserWithEmailAndPassword(email, pass).then(res => {
      db.collection("users").doc(res.user.uid).set({
        name: name,
        avatar: ""
      });
    }).catch(alert);
  }

  function login() {
    auth.signInWithEmailAndPassword(email.value, password.value).catch(alert);
  }

  function loadUser() {
    db.collection("users").doc(currentUser.uid).get().then(doc => {
      userName.innerText = doc.data().name;
    });
  }

  function addPost() {
    db.collection("posts").add({
      uid: currentUser.uid,
      text: postText.value,
      image: postImage.value,
      likes: [],
      created: Date.now()
    });
    postText.value = "";
    postImage.value = "";
  }

  function loadPosts() {
    db.collection("posts").orderBy("created","desc")
      .onSnapshot(snap => {
        posts.innerHTML = "";
        snap.forEach(doc => {
          const p = doc.data();
          const liked = p.likes.includes(currentUser.uid);

          posts.innerHTML += `
            <div class="post">
              <p>${p.text}</p>
              ${p.image ? `<img src="${p.image}">` : ""}
              <div class="like" onclick="likePost('${doc.id}')">
                ‚ù§Ô∏è ${p.likes.length} ${liked ? "(—Ç—ã –ª–∞–π–∫–Ω—É–ª)" : ""}
              </div>
            </div>`;
        });
      });
  }

  function likePost(id) {
    const ref = db.collection("posts").doc(id);
    ref.get().then(doc => {
      let likes = doc.data().likes;
      if (likes.includes(currentUser.uid)) {
        likes = likes.filter(l => l !== currentUser.uid);
      } else {
        likes.push(currentUser.uid);
      }
      ref.update({ likes });
    });
  }
</script>
</body>
</html>
